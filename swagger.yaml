openapi: 3.0.0
info:
  title: Multi-Tenant Calendar API
  version: 1.0.0
  description: API for managing tenant events with Google Calendar integration

servers:
  - url: https://dev.matterminer.com/calendar
    description: Development Server

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    Event:
      type: object
      properties:
        id: { type: string, format: uuid }
        title: { type: string }
        description: { type: string } 
        provider: { type: string }  
        startTime: { type: string, format: date-time }
        endTime: { type: string, format: date-time }
        providerEventId: { type: string, nullable: true }

    WatchRequest:
      type: object
      required: [id, type, address]
      properties:
        id:
          type: string
          format: uuid
          description: A unique string that identifies this new channel.
        type:
          type: string
          example: "web_hook"
        address:
          type: string
          format: uri
          description: The URL where you want Google to send notifications.
        token:
          type: string
          description: An arbitrary string delivered to the target address with each notification. Use this for security/validation.
        expiration:
          type: string
          format: int64
          description: Unix timestamp (ms) when this channel should expire.

    SyncMessage:
      type: object
      properties:
        tenantId:
          type: string
          example: "tenant_123"
        action:
          type: string
          enum: [INCREMENTAL_SYNC, FULL_SYNC, DISCONNECT]
          example: "INCREMENTAL_SYNC"
        timestamp:
          type: string
          format: date-time
        priority:
          type: integer
          minimum: 1
          maximum: 10
          default: 5

    CalendarEventProcessed:
      type: object
      properties:
        eventId:
          type: string
        status:
          type: string
          example: "synced_to_db"
        routingKey:
          type: string
          example: "events.updated"
security:
  - bearerAuth: []

paths:
  /events:
    get:
      summary: Retrieve all events
      tags: [Events]
      responses:
        200:
          description: A list of events
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Event'
    post:
      summary: Create a new event
      tags: [Events]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Event'
      responses:
        201:
          description: Created

  /events/{id}:
    get:
      summary: Get event by ID
      tags: [Events]
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        200:
          description: Success
    delete:
      summary: Delete event
      tags: [Events]
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        200:
          description: Deleted

  /events/sync-google:
    post:
      summary: Trigger Google Sync
      tags: [Sync]
      responses:
        200:
          description: Sync initiated

  /auth/google:
    get:
      summary: Initialize Google OAuth flow
      description: Redirects the user to Google's consent screen. Requires a tenantId query parameter to track the session.
      tags: [Auth]
      parameters:
        - in: query
          name: tenantId
          schema:
            type: string
          required: true
          description: Unique ID for the tenant (defaults to 'default_tenant')
      responses:
        302:
          description: Redirect to Google Authorization Server
        500:
          description: Internal Server Error

  /auth/oauth2callback:
    get:
      summary: Google OAuth callback handler
      description: This endpoint is called by Google after the user authorizes the app. It exchanges the auth code for tokens, stores them in Redis, and issues a JWT.
      tags: [Auth]
      parameters:
        - in: query
          name: code
          schema:
            type: string
          required: true
          description: The authorization code provided by Google
        - in: query
          name: state
          schema:
            type: string
          description: Usually contains the tenantId passed during the initial request
      responses:
        200:
          description: Successful authentication
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean, example: true }
                  jwtToken: { type: string, description: "Bearer token for subsequent API calls" }
                  tenantId: { type: string }
        400:
          description: Missing authorization code
        500:
          description: Failed to exchange tokens or store session

  /webhook/register:
    post:
      summary: Start watching a Google Calendar
      description: Tells Google to start sending notifications to our webhook URL whenever a calendar changes.
      tags: [Webhooks]
      security:
        - bearerAuth: []
      responses:
        200:
          description: Watch successfully registered
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WatchRequest'

  /webhook/google:
    post:
      summary: Google Calendar Notification Receiver
      description: |
        The public endpoint that Google pings. 
        Note: This endpoint is called by Google, not by the client. 
        It expects headers like `x-goog-channel-id` and `x-goog-resource-state`.
      tags: [Webhooks]
      responses:
        200:
          description: Acknowledged
        404:
          description: Channel ID not recognized

  /sync/trigger:
    post:
      summary: Manually trigger tenant sync
      description: Pushes a 'SyncMessage' to the RabbitMQ exchange to begin background processing.
      tags: [Sync]
      security:
        - bearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                forceFullSync:
                  type: boolean
                  default: false
      responses:
        202:
          description: Sync request accepted and queued
          content:
            application/json:
              schema:
                type: object
                properties:
                  jobId: { type: string, format: uuid }
                  status: { type: string, example: "queued" }

  /sync/status/{jobId}:
    get:
      summary: Check background sync status
      tags: [Sync]
      parameters:
        - in: path
          name: jobId
          required: true
          schema:
            type: string
      responses:
        200:
          description: Current status of the sync job
